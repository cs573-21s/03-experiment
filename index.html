<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/holtzy/D3-graph-gallery@master/LIB/d3-scale-radial.js"></script>

<style>
  #end-screen {
    display: none;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    width: 100vw;
    height: 100vh;
  }

  .trial {
    display: flex;
    justify-content: space-evenly;
    flex-direction: row;
    width: 100vw;
    height: 100vh;
  }

  .question {
    display: flex;
    flex-direction: column;
    justify-content: center;
    width: 70vw;
    height: 100vh;
  }

  .button {
    color: white;
    background-color: green;
    border: none;
    width: 8.5rem;
    height: 2rem;
  }

  .button:hover {
    cursor: pointer;
    background-color: forestgreen;
  }

  #restart-button {
    margin-top: 1rem;
  }

  #submit-button {

  }

  body {
    margin: 0;
  }

  .svg-container {
    display: inline-block;
    position: relative;
    width: 100vw;
    height: 100vh;
    vertical-align: top;
    overflow: hidden;
  }

  .svg-content {
    display: inline-block;
    position: absolute;
    top: 0;
    left: 0;
  }

  #guess {
    width: 180px;
  }

  #radar {
    display: none;
  }

  #bargraph {
    display: none;
  }

  #circularbarplot {
    display: flex;
  }

</style>

<body>
  
  <div class="trial" >
    <div id="circularbarplot" class="svg-container"></div>
    <svg id="bargraph"></svg>
    <div id="radar" class="svg-container"></div>
    <div class="question">
      <p>Question</p>
      <label for="guess">Percentage Larger Estimate</label><br>
      <input type="text" id="guess" name="guess" value="50"><br>
      <input class="button" id="submit-button" type="submit" value="Submit Answer">
    </div>
  </div>

  <div id="end-screen">
    <p>You have successfully completed the experiment, and we have recorded your results.</p>
    <button class="button" id="restart-button">Restart Experiment</button>
  </div>

</body>

<script>
  console.log(d3); // test if d3 is loaded

  /* - - - - - - - - Data Generation - - - - - - - -
  ** Everytime you need a dataset, set a variable = to the generateDataset() function.
  ** This creates a struct with all the dataset information.
  ** For example, you can do: let data1 = generateDataset();
  ** In this case, get the dataset array using data1.dataset
  ** To get the indices for comparison, use data1.mark1 and data1.mark2
  ** (mark1 and mark2 are just the index in the array of the chosen points.)
  */
  function generateDataset() {
    //choose size of data set between 5-10
    let datasetCount = Math.floor(Math.random() * 6) + 5; 

    //choose two random data points
    let chosenPoint1 = Math.floor(Math.random() * datasetCount);
    let chosenPoint2 = Math.floor(Math.random() * datasetCount);
    while (chosenPoint1 == chosenPoint2) { //make sure we did not choose same one twice
      chosenPoint2 = Math.floor(Math.random() * datasetCount);
    }
    
    //create dataset
    let myDataset = Array.from({length: datasetCount}, () => Math.floor(Math.random() * 101));

    var letterData = [
        {letter: "A", frequency: myDataset[0]},
        {letter: "B", frequency: myDataset[1]},
        {letter: "C", frequency: myDataset[2]},
        {letter: "D", frequency: myDataset[3]},
        {letter: "E", frequency: myDataset[4]},
        {letter: "F", frequency: myDataset[5]},
        {letter: "G", frequency: myDataset[6]},
        {letter: "H", frequency: myDataset[7]},
        {letter: "I", frequency: myDataset[8]},
        {letter: "J", frequency: myDataset[9]}
    ];

    letterData.length = datasetCount; //Reduce array to correct size

    //create struct
    var data = {
      mark1: chosenPoint1,
      mark2: chosenPoint2,
      dataset: letterData
    };

    return data;
  }

  //let data1 = generateDataset();
  //console.log("mark1: " + data1.mark1 + " mark2: " + data1.mark2 + " dataset: " + data1.dataset);
</script>

<script>

  function generateVisOrder() {
    // 60 visualizations
    // 20 per visualization type
    let order = []
    let radarCount = 0;
    let bargraphCount = 0;
    let circularbarplotCount = 0;
    
    while (order.length < 60) {
      let randomNum = Math.floor(Math.random()*3)

      if (randomNum == 0) {
        if (radarCount >= 20)
          continue;
        else
          radarCount++
      } else if (randomNum == 1) {
        if (bargraphCount >=20)
          continue;
        else 
          bargraphCount++
      } else {
        if (circularbarplotCount >= 20)
          continue;
        else
          circularbarplotCount++
      }
      order.push(randomNum)
    }

    return order;
  }

  // let orderArray = generateVisOrder()
</script>

<script>
  console.log(d3);

  var margin = { top: 190, right: 0, bottom: 0, left: 200 },
      width = 450 - margin.left - margin.right,
      height = 450 - margin.top - margin.bottom,
      innerRadius = 40,
      outerRadius = Math.min(width, height) / 2;

  var svg = d3.select('div#circularbarplot').append('svg')
      .attr('viewBox', '0 0 390 1080')
      .attr('preserveAspectRatio', 'xMinYMin meet')
      .classed('svg-content', true)

  function generateCircularBarplot(data, mark1, mark2) {

      console.log(data)

      // Scales
      var x = d3.scaleBand()
          .range([0, 2 * Math.PI])    // X axis goes from 0 to 2pi = all around the circle. If I stop at 1Pi, it will be around a half circle
          .domain(data.map(function(d) { return d.letter; })); // The domain of the X axis is the list of states.
      var y = d3.scaleRadial()
          .range([innerRadius, outerRadius])   // Domain will be define later.
          .domain([0, 100]); // Domain of Y is from 0 to the max seen in the data

      // Add the bars
      svg.append("g")
      .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')
      .selectAll("path")
      .data(data)
      .enter()
      .append("path")
          .attr("fill", "black")
          .attr("d", d3.arc()     // imagine your doing a part of a donut plot
              .innerRadius(innerRadius)
              .outerRadius(function(d) { 
                  console.log(d);
                  return y(d['frequency']); })
              .startAngle(function(d) { return x(d.letter); })
              .endAngle(function(d) { return x(d.letter) + x.bandwidth(); })
              .padAngle(0.01)
              .padRadius(innerRadius))

      // Add the labels
      svg.append("g")
          .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')
          .selectAll("g")
          .data(data)
          .enter()
          .append("g")
          .attr("text-anchor", function(d) { return (x(d.letter) + x.bandwidth() / 2 + Math.PI) % (2 * Math.PI) < Math.PI ? "end" : "start"; })
          .attr("transform", function(d) { return "rotate(" + ((x(d.letter) + x.bandwidth() / 2) * 180 / Math.PI - 90) + ")"+"translate(" + (y(d['frequency'])+10) + ",0)"; })
          .append("text")
          .text(function(d){return(d.letter)})
          .attr("transform", function(d) { return (x(d.letter) + x.bandwidth() / 2 + Math.PI) % (2 * Math.PI) < Math.PI ? "rotate(180)" : "rotate(0)"; })
          .style("font-size", "13px")
          .attr("alignment-baseline", "middle")
  }

  let data = generateDataset();
  console.log("mark1: " + data.mark1 + " mark2: " + data.mark2 + " dataset: " + data.dataset);
  generateCircularBarplot(data.dataset, data.mark1, data.mark2);
</script>

<script>
  // establishing variables
  var margin = 50,           
  width = 500 - 2 * margin,
  height = 500 - 2 * margin;

  // creating svg
  var svg = d3.select("#bargraph")             
    .attr("width", width + 2 * margin)
    .attr("height", height + 2 * margin)
    .attr("transform", "translate(" + margin + ", " + margin + ")")

  /*-----------------------Bar Chart--------------------------
  ** When you need to create a bar chart with a given data set, use 
  ** buildBarChart(d) where d is the data returned from generateDataset()
  */
  function buildBarChart(data){
    var d = data.dataset,
    mark1 = data.mark1,
    mark2 = data.mark2;
    //console.log(d);

    // scaling
    var xscale = d3.scaleBand()
      .domain(d.map(function(d){ return (d.letter) }))
      .range( [0, width])
      .padding(0.4);

    var yscale = d3.scaleLinear()
      .domain( d3.extent(d, function(d){ return d.frequency; }))
      .range( [height, 0] );

    // Add X axis
    var x_axis = d3.axisBottom()
    .scale(xscale)
    svg.append("g")
      .attr("transform", "translate(" + margin + "," + height + ")")
      .call(x_axis)
      .attr("class", "xAxis")
      
    // Add Y axis
    var y_axis = d3.axisLeft()
      .scale(yscale)
    svg.append("g")
      .attr("transform", "translate(" + margin + ", 0 )")
      .call(y_axis)
      .attr("class", "yAxis")

    // Add X axis label
    svg.append("text")             
      .attr("text-anchor", "middle")
      .attr("x", width/2 + margin)
      .attr("y", height + 40)
      .text("Letter");

    // Add Y axis label
    svg.append("text")
      .attr("text-anchor", "middle")
      .attr("x", -(height/2))
      .attr("y", 0)
      .attr("dy", ".75em")
      .attr("transform", "rotate(-90)")
      .text("Frequency");  

    // Add Bars
    var bars = svg.selectAll(".bar")
      .data(d)
      .enter().append("rect")
      .attr("class", "bar")
      .attr("x", function(d){ return xscale(d.letter)+margin })
      .attr("y", function(d){ return height - yscale(d.frequency) })
      .attr("height", function(d){ return yscale(d.frequency)})
      .attr("width", function(d){ return xscale.bandwidth() })
  }
</script>

<script>
  
  var visOrder = []
  var trialCount = 0 // will iterate after each press of the submission button except the first

  // press button to start program  
  function start() {
    visOrder = generateVisOrder()
    generateNextTrial(trialCount)
  }

  function generateNextTrial(trialNum) {
    let visType = visOrder[trialNum]
    // randomly generate data
    if (visType == 0) { // radar
      // load in radar 
    } else if (visType == 1) { // bargraph
      // load in bargraph
    } else { // circular barplot
      // load in circular barplot
    }
    // load question based on randomly generated data
  }

  async function submitAnswer(answer) {
    // checks for valid answer
    // send answer to storage
    trialCount = trialCount++
    generateNextTrial(trialCount)
  }
    

</script>